version: 2.1

jobs:
  test:
    environment:
      TEST_RESULTS: /tmp/test-results
    working_directory: /go/src/github.com/twingate/terraform-provider-twingate
    docker:
      - image: circleci/golang:1.16

    steps:
      - checkout

      - restore_cache:
          keys:
            - go-mod-v1-{{ checksum "go.sum" }}

      - run:
          name: Format Check
          command: |
            make fmtcheck

      - run:
          name: Run Lint
          command: |
            make lint

      - run:
          name: Run Sec Check
          command: |
            make sec

      - run:
          name: Run Acc tests
          command: |
            make testacc

      - run:
          name: Publish coverage report
          command: ./scripts/coveralls.sh

      # Store Artifacts
      - store_artifacts:
          path: /tmp/test-results/coverage.html
          destination: coverage.html

      - store_test_results:
          path: /tmp/test-results



  build:

    docker:
      - image: circleci/golang:1.16

    working_directory: /go/src/github.com/twingate/terraform-provider-twingate

    steps:
      - checkout
      - restore_cache:
          keys:
            - go-mod-v1-{{ checksum "go.sum" }}

      - run:
          name: Build
          command: make build-release

      - run:
          name: Compute checksum of binaries
          command: |
            for binary in build/*; do
              sha256sum -b $binary > $binary.sha256
            done

      - save_cache: # Store cache in the /go/pkg directory
          key: go-mod-v1-{{ checksum "go.sum" }}
          paths:
            - "/go/pkg/mod"

      - persist_to_workspace:
          root: /go/src/github.com/twingate/terraform-provider-twingate
          paths:
            - build

  release:

    docker:
      - image: golang:1.16

    working_directory: /build

    steps:
      - attach_workspace:
          at: /
      - run:
          name: Instal GHR
          command: |
            go get github.com/tcnksm/ghr
      - run:
          name: Publish release
          command: |
            ghr -t ${GITHUB_TOKEN} -u ${CIRCLE_PROJECT_USERNAME} -r ${CIRCLE_PROJECT_REPONAME} -c ${CIRCLE_SHA1} -delete -draft ${CIRCLE_TAG} .

workflows:
  version: 2
  build:
   jobs:
     - test:
         context:
           - terraform-provider

     - build:
         requires:
           - test

     - release:
         requires:
           - build
         filters:
           branches:
             ignore: /.*/
           tags:
             only: /^v\d+\.\d+\.\d+$/