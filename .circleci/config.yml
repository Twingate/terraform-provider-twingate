version: 2.1

jobs:
  test:
    environment:
      TEST_RESULTS: /tmp/test-results
    working_directory: /go/src/github.com/twingate/terraform-provider-twingate
    docker:
      - image: circleci/golang:1.16

    steps:
      - checkout

      - restore_cache:
          keys:
            - go-mod-v1-{{ checksum "go.sum" }}

      - run:
          name: Format Check
          command: |
            make fmtcheck

      - run:
          name: Run Lint
          command: |
            make lint

      - run:
          name: Run Sec Check
          command: |
            make sec

      - run:
          name: Run Acc tests
          command: |
            make testacc

      - run:
          name: Publish coverage report
          command: ./scripts/coveralls.sh

      # Store Artifacts
      - store_artifacts:
          path: /tmp/test-results/coverage.html
          destination: coverage.html

      - store_test_results:
          path: /tmp/test-results



  build:

    docker:
      - image: circleci/golang:1.16

    working_directory: /go/src/github.com/twingate/terraform-provider-twingate

    steps:
      - checkout

      - restore_cache:
          keys:
            - go-mod-v1-{{ checksum "go.sum" }}

      - run:
          name: Build
          command: make build

      - save_cache: # Store cache in the /go/pkg directory
          key: go-mod-v1-{{ checksum "go.sum" }}
          paths:
            - "/go/pkg/mod"

workflows:
  version: 2
  build:
   jobs:
     - test:
         context:
           - terraform-provider

     - build:
         requires:
           - test

