package resource

import (
	"context"
	"errors"
	"fmt"
	"log"

	"github.com/Twingate/terraform-provider-twingate/twingate/internal/client"
	"github.com/Twingate/terraform-provider-twingate/twingate/internal/model"
	"github.com/hashicorp/terraform-plugin-sdk/v2/diag"
	"github.com/hashicorp/terraform-plugin-sdk/v2/helper/schema"
)

var ErrNotAllowChangeRemoteNetworkID = errors.New("connectors cannot be moved between Remote Networks: you must either create a new Connector or destroy and recreate the existing one")

func Connector() *schema.Resource {
	return &schema.Resource{
		Description:   "Connectors provide connectivity to Remote Networks. This resource type will create the Connector in the Twingate Admin Console, but in order to successfully deploy it, you must also generate Connector tokens that authenticate the Connector with Twingate. For more information, see Twingate's [documentation](https://docs.twingate.com/docs/understanding-access-nodes).",
		CreateContext: connectorCreate,
		ReadContext:   connectorRead,
		DeleteContext: connectorDelete,
		UpdateContext: connectorUpdate,
		CustomizeDiff: func(ctx context.Context, d *schema.ResourceDiff, m interface{}) error {
			const key = "remote_network_id"
			oldVal, _ := d.GetChange(key)
			old := oldVal.(string)
			if old != "" && d.HasChange(key) {
				return ErrNotAllowChangeRemoteNetworkID
			}

			return nil
		},

		Schema: map[string]*schema.Schema{
			// required
			"remote_network_id": {
				Type:        schema.TypeString,
				Required:    true,
				ForceNew:    true,
				Description: "The ID of the Remote Network the Connector is attached to",
			},
			"name": {
				Type:        schema.TypeString,
				Optional:    true,
				Computed:    true,
				Description: "Name of the Connector, if not provided one will be generated",
			},
			// computed
			"id": {
				Type:        schema.TypeString,
				Computed:    true,
				Description: "Autogenerated ID of the Connector, encoded in base64",
			},
		},
		Importer: &schema.ResourceImporter{
			StateContext: schema.ImportStatePassthroughContext,
		},
	}
}

func connectorCreate(ctx context.Context, resourceData *schema.ResourceData, meta interface{}) diag.Diagnostics {
	c := meta.(*client.Client)

	remoteNetworkID := resourceData.Get("remote_network_id").(string)
	connectorName := resourceData.Get("name").(string)
	connector, err := c.CreateConnector(ctx, remoteNetworkID, connectorName)

	return resourceConnectorReadHelper(resourceData, connector, err)
}
func connectorUpdate(ctx context.Context, resourceData *schema.ResourceData, meta interface{}) diag.Diagnostics {
	// only `name` allowed to change
	if !resourceData.HasChange("name") {
		return nil
	}

	c := meta.(*client.Client)

	connector, err := c.UpdateConnector(ctx, resourceData.Id(), resourceData.Get("name").(string))

	return resourceConnectorReadHelper(resourceData, connector, err)
}

func connectorDelete(ctx context.Context, resourceData *schema.ResourceData, meta interface{}) diag.Diagnostics {
	c := meta.(*client.Client)
	connectorID := resourceData.Id()

	err := c.DeleteConnector(ctx, connectorID)
	if err != nil {
		return diag.FromErr(err)
	}

	log.Printf("[INFO] Destroyed connector id %s", connectorID)

	return nil
}

func connectorRead(ctx context.Context, resourceData *schema.ResourceData, meta interface{}) diag.Diagnostics {
	c := meta.(*client.Client)
	connector, err := c.ReadConnector(ctx, resourceData.Id())

	return resourceConnectorReadHelper(resourceData, connector, err)
}

func resourceConnectorReadHelper(resourceData *schema.ResourceData, connector *model.Connector, err error) diag.Diagnostics {
	if err != nil {
		if errors.Is(err, client.ErrGraphqlResultIsEmpty) {
			// clear state
			resourceData.SetId("")

			return nil
		}

		return diag.FromErr(err)
	}

	if err := resourceData.Set("name", connector.Name); err != nil {
		return diag.FromErr(fmt.Errorf("error setting name: %w ", err))
	}

	if err := resourceData.Set("remote_network_id", connector.NetworkID); err != nil {
		return diag.FromErr(fmt.Errorf("error setting remote_network_id: %w ", err))
	}

	resourceData.SetId(connector.ID)

	return nil
}
